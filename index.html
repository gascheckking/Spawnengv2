<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SpawnEngine ‚Äî Onchain Pack Factory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-primary: #020617;
      --bg-secondary: #050816;
      --bg-tertiary: #0b1220;
      --text-primary: #f9fafb;
      --text-secondary: #9ca3af;
      --accent: #00d4ff;
      --accent-soft: rgba(0, 212, 255, 0.18);
      --border: #1f2937;
      --success: #22c55e;
      --danger: #f97373;
      --font-mono: "SF Mono", "Fira Code", monospace;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #0f172a 0, #020617 40%, #000 100%);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      display: flex;
      justify-content: center;
      align-items: stretch;
      min-height: 100vh;
      padding: 0.8rem;
    }

    .app-frame {
      width: 100%;
      max-width: 480px;
      border-radius: 1.2rem;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.9),
        0 16px 40px rgba(0, 0, 0, 0.9);
      background: radial-gradient(circle at top, #020617 0, #020617 45%, #020617 100%);
      display: flex;
      flex-direction: column;
    }

    /* HEADER */

    .app-header {
      padding: 0.75rem 0.9rem;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(to right, #020617, #020617 40%, #020617);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .brand {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }
    .brand-title {
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      color: var(--accent);
    }
    .brand-sub {
      font-size: 0.7rem;
      color: var(--text-secondary);
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .network-pill {
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      background: #020617;
      border: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 0.65rem;
      color: var(--text-secondary);
    }
    .btn {
      border-radius: 0.5rem;
      border: 1px solid var(--accent);
      background: var(--accent-soft);
      padding: 0.35rem 0.8rem;
      font-size: 0.75rem;
      color: var(--accent);
      cursor: pointer;
      font-weight: 600;
      transition: background 0.18s, color 0.18s, border-color 0.18s, transform 0.08s;
    }
    .btn:hover {
      background: var(--accent);
      color: #020617;
      transform: translateY(-1px);
    }
    .btn-small {
      padding: 0.25rem 0.6rem;
      font-size: 0.7rem;
    }

    /* TAB BAR */

    .tab-bar {
      display: flex;
      overflow-x: auto;
      border-bottom: 1px solid var(--border);
      background: #020617;
    }
    .tab-bar::-webkit-scrollbar { display: none; }

    .tab-btn {
      border: none;
      background: transparent;
      color: var(--text-secondary);
      padding: 0.6rem 0.7rem;
      font-size: 0.75rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      white-space: nowrap;
    }
    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* STATUS / TICKER */

    .status-strip {
      padding: 0.35rem 0.7rem;
      background: #020617;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
    }
    .status-left,
    .status-right {
      display: flex;
      gap: 0.55rem;
      align-items: center;
      color: var(--text-secondary);
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #4b5563;
      display: inline-block;
      margin-right: 0.2rem;
    }
    .status-dot.on { background: var(--success); }

    .ticker {
      overflow: hidden;
      background: #020617;
      border-bottom: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 0.7rem;
      padding: 0.3rem 0;
    }
    .ticker-inner {
      white-space: nowrap;
      animation: ticker-scroll 22s linear infinite;
      padding-left: 100%;
    }
    @keyframes ticker-scroll {
      from { transform: translateX(0); }
      to { transform: translateX(-100%); }
    }

    /* MAIN / VIEW */

    .app-main {
      flex: 1;
      min-height: 0;
      padding: 0.7rem;
      overflow-y: auto;
    }
    .view-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin: 0 0 0.6rem;
    }

    .card-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.6rem;
    }
    @media (min-width: 480px) {
      .card-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .card {
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #020617 100%);
      border-radius: 0.8rem;
      border: 1px solid var(--border);
      padding: 0.8rem;
    }
    .card h3 {
      margin: 0 0 0.3rem;
      color: var(--accent);
      font-size: 0.9rem;
    }
    .card p {
      margin: 0.15rem 0;
      font-size: 0.72rem;
      color: var(--text-secondary);
    }

    .metric-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.6rem;
    }
    .metric {
      background: #020617;
      border-radius: 0.8rem;
      border: 1px solid var(--border);
      padding: 0.7rem;
      text-align: center;
    }
    .metric .value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent);
    }
    .metric .label {
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    /* PACK MAP */

    .packmap-wrap { margin-top: 0.5rem; }
    .packmap-canvas {
      width: 100%;
      height: 220px;
      background: radial-gradient(circle at center, #020617 0, #000 100%);
      border-radius: 0.9rem;
      border: 1px solid var(--border);
      display: block;
    }

    /* PROFILE & TASKS */

    .profile-header {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      margin-bottom: 0.6rem;
    }
    .profile-wallet {
      font-family: var(--font-mono);
      font-size: 0.72rem;
      color: var(--text-secondary);
    }
    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }
    .badge {
      border-radius: 999px;
      padding: 0.18rem 0.5rem;
      font-size: 0.65rem;
      border: 1px solid var(--border);
      background: #020617;
    }

    .task-list {
      list-style: none;
      padding: 0;
      margin: 0.4rem 0 0;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .task-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #020617;
      border-radius: 0.6rem;
      border: 1px solid var(--border);
      padding: 0.4rem 0.55rem;
      font-size: 0.7rem;
      color: var(--text-secondary);
    }
    .task-item.done {
      opacity: 0.6;
    }
    .task-label {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }
    .task-xp {
      color: var(--accent);
      font-size: 0.65rem;
    }

    /* FOOTER */

    .app-footer {
      padding: 0.55rem 0.7rem;
      border-top: 1px solid var(--border);
      background: #020617;
      font-size: 0.68rem;
      text-align: center;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div id="app" class="app-frame"></div>

  <script type="module">
    // --------------------------------------
    // MOCK MESH DATA
    // --------------------------------------
    const MOCK_EVENTS = [
      {
        id: "1",
        kind: "pack_open",
        label: "Genesis Pack #42",
        short: "GEN-42",
        series: "Genesis",
        rarity: "Core",
        owner: "0x1234...beef",
        tags: ["pull", "core"],
        score: 420,
        timestamp: Date.now() - 5000,
      },
      {
        id: "2",
        kind: "swap",
        label: "Shard ‚Üí Core",
        short: "S>C",
        series: "Genesis",
        rarity: "Shard",
        owner: "0x9999...aaaa",
        tags: ["swap"],
        score: 210,
        timestamp: Date.now() - 25000,
      },
      {
        id: "3",
        kind: "burn",
        label: "Burn 10 Fragments",
        short: "10xF",
        series: "Genesis",
        rarity: "Fragment",
        owner: "0xabcd...0001",
        tags: ["burn", "gamble"],
        score: 90,
        timestamp: Date.now() - 60000,
      },
      {
        id: "4",
        kind: "zora_buy",
        label: "ZoraPack Mythic Hit",
        short: "Z-MYT",
        series: "ZoraPacks",
        rarity: "Relic",
        owner: "0xdeaf...9999",
        tags: ["zora", "mythic_hit"],
        score: 9900,
        timestamp: Date.now() - 120000,
      },
      {
        id: "5",
        kind: "farcaster_cast",
        label: "Cast: ‚ÄúJust pulled an Artifact on Base‚Äù",
        short: "CAST",
        series: "Social",
        rarity: "Artifact",
        owner: "0xface...7777",
        tags: ["farcaster", "social"],
        score: 300,
        timestamp: Date.now() - 240000,
      },
    ];

    function getUnifiedActivity() {
      return Promise.resolve(
        MOCK_EVENTS.slice().sort((a, b) => b.timestamp - a.timestamp)
      );
    }

    function computeStatsFromEvents(events) {
      const stats = {
        totalPacks: 0,
        fragments: 0,
        shards: 0,
        cores: 0,
        artifacts: 0,
        relics: 0,
        holderCount: 0,
        luckIndex: 0,
      };
      const holders = new Set();
      for (const e of events) {
        if (e.kind === "pack_open") stats.totalPacks++;
        switch (e.rarity) {
          case "Fragment": stats.fragments++; break;
          case "Shard": stats.shards++; break;
          case "Core": stats.cores++; break;
          case "Artifact": stats.artifacts++; break;
          case "Relic": stats.relics++; break;
        }
        holders.add(e.owner);
      }
      stats.holderCount = holders.size;

      // Enkel luck-index: Relic/Artifact/Cores plus, Fragments minus
      stats.luckIndex =
        stats.relics * 120 +
        stats.artifacts * 40 +
        stats.cores * 5 +
        stats.shards * 1 -
        stats.fragments * 2;

      return stats;
    }

    function postCastMock(message, url) {
      console.log("[FAKE CAST]", message, url || "");
      return Promise.resolve({ ok: true, id: "fake_cast_id" });
    }

    // --------------------------------------
    // STATE
    // --------------------------------------
    const NETWORK_INFO = {
      name: "Base Sepolia",
      label: "Base ¬∑ Pack ecosystems",
    };

    const state = {
      wallet: null,
      connected: false,
      theme: "dark",
      currentTab: "trading",
      events: [],
      stats: null,
      profile: {
        streakDays: 3,
        xp: 1250,
        level: 4,
        bestHit: "Relic (ZoraPack)",
      },
      daily: {
        tasks: [
          { id: "open-pack", label: "Open 1 pack", xp: 25, done: false },
          { id: "do-trade", label: "Do 1 trade / swap", xp: 20, done: false },
          { id: "cast-social", label: "Share 1 pull on-chain", xp: 30, done: false },
        ],
      },
    };

    const TABS = [
      "trading",
      "my-packs",
      "creator-forge",
      "pull-lab",
      "pack-maps",
      "warp-verified",
      "bubbles",
      "stats-engine",
      "deploy-center",
      "profile",
      "settings",
    ];

    function humanTabName(id) {
      return id
        .replace(/-/g, " ")
        .replace(/\b\w/g, (c) => c.toUpperCase());
    }

    // --------------------------------------
    // INIT
    // --------------------------------------
    async function init() {
      const root = document.getElementById("app");
      root.innerHTML = `
        <header class="app-header">
          <div class="brand">
            <div class="brand-title">SpawnEngine</div>
            <div class="brand-sub">Onchain Pack Factory ¬∑ Pack Mesh Protocol</div>
          </div>
          <div class="header-right">
            <div class="network-pill" id="network-pill">${NETWORK_INFO.label}</div>
            <button id="wallet-btn" class="btn">Connect</button>
          </div>
        </header>

        <nav class="tab-bar" id="tab-bar"></nav>

        <div class="status-strip">
          <div class="status-left">
            <span><span id="wallet-dot" class="status-dot"></span><span id="wallet-status">Wallet: Disconnected</span></span>
            <span>Theme: Dark</span>
          </div>
          <div class="status-right">
            <span>Gas: 0.26 gwei</span>
            <span>Mesh: Live</span>
          </div>
        </div>

        <div class="ticker">
          <div class="ticker-inner" id="ticker-inner"></div>
        </div>

        <main class="app-main">
          <h2 class="view-title" id="view-title"></h2>
          <div id="view-body"></div>
        </main>

        <footer class="app-footer">
          SpawnEngine ¬∑ Base ¬∑ Zora ¬∑ Farcaster ¬∑ Unified Activity Mesh
        </footer>
      `;

      setupTabs();
      setupWallet();

      state.events = await getUnifiedActivity();
      state.stats = computeStatsFromEvents(state.events);

      renderTicker();
      switchView("trading");
    }

    function setupTabs() {
      const bar = document.getElementById("tab-bar");
      bar.innerHTML = "";
      TABS.forEach((id) => {
        const btn = document.createElement("button");
        btn.className = "tab-btn";
        btn.dataset.tab = id;
        btn.textContent = humanTabName(id);
        btn.addEventListener("click", () => switchView(id));
        bar.appendChild(btn);
      });
      const first = bar.querySelector(".tab-btn");
      if (first) first.classList.add("active");
    }

    function setActiveTab(id) {
      document.querySelectorAll(".tab-btn").forEach((b) => {
        b.classList.toggle("active", b.dataset.tab === id);
      });
    }

    function setupWallet() {
      const btn = document.getElementById("wallet-btn");
      const status = document.getElementById("wallet-status");
      const dot = document.getElementById("wallet-dot");

      btn.addEventListener("click", () => {
        state.connected = !state.connected;
        state.wallet = state.connected
          ? "0x" + Math.random().toString(16).slice(2, 8) + "...mesh"
          : null;

        btn.textContent = state.connected ? "Disconnect" : "Connect";
        status.textContent = state.connected
          ? "Wallet: " + state.wallet
          : "Wallet: Disconnected";
        dot.classList.toggle("on", state.connected);
      });
    }

    function renderTicker() {
      const el = document.getElementById("ticker-inner");
      const line = state.events
        .map((e) => e.short + " ¬∑ " + e.rarity + " ¬∑ " + e.owner)
        .join("   ‚Ä¢   ");
      el.textContent = line;
    }

    function switchView(id) {
      state.currentTab = id;
      setActiveTab(id);
      const title = document.getElementById("view-title");
      const body = document.getElementById("view-body");

      title.textContent = humanTabName(id);

      const map = {
        "trading": viewTrading,
        "my-packs": viewMyPacks,
        "creator-forge": viewCreatorForge,
        "pull-lab": viewPullLab,
        "pack-maps": viewPackMaps,
        "warp-verified": viewWarpVerified,
        "bubbles": viewBubbles,
        "stats-engine": viewStatsEngine,
        "deploy-center": viewDeployCenter,
        "profile": viewProfile,
        "settings": viewSettings,
      };

      const renderer = map[id] || function () { return "<p>Not implemented yet.</p>"; };
      body.innerHTML = renderer();

      if (id === "pack-maps") drawPackMap();
    }

    // --------------------------------------
    // HELPERS / DYNAMISKA EVENTS
    // --------------------------------------
    function addMeshEvent(evt) {
      evt.id = "evt-" + (Date.now() + Math.random().toString(16).slice(2, 6));
      evt.timestamp = Date.now();
      state.events.unshift(evt);
      state.stats = computeStatsFromEvents(state.events);
      renderTicker();
      if (state.currentTab === "trading") {
        switchView("trading");
      }
      if (state.currentTab === "my-packs") {
        switchView("my-packs");
      }
      if (state.currentTab === "stats-engine") {
        switchView("stats-engine");
      }
    }

    function randomRarityForZoraPack() {
      const roll = Math.random();
      if (roll < 0.7) return "Fragment";
      if (roll < 0.88) return "Shard";
      if (roll < 0.96) return "Core";
      if (roll < 0.995) return "Artifact";
      return "Relic";
    }

    // --------------------------------------
    // VIEWS
    // --------------------------------------
    function viewTrading() {
      const events = state.events;
      const rows = events.map(function(e) {
        var icon = "üì¶";
        if (e.kind === "swap") icon = "üîÑ";
        if (e.kind === "burn") icon = "üî•";
        if (e.kind === "zora_buy") icon = "ü™ô";
        if (e.kind === "farcaster_cast") icon = "üì°";
        return (
          '<div class="card">' +
            "<h3>" + icon + " " + e.label + "</h3>" +
            "<p>Kind: " + e.kind + "</p>" +
            "<p>Series: " + e.series + "</p>" +
            "<p>Rarity: " + e.rarity + "</p>" +
            "<p>Owner: " + e.owner + "</p>" +
            '<button class="btn btn-small" data-share-id="' + e.id + '">Share pull</button>' +
          "</div>"
        );
      }).join("");
      return '<div class="card-grid">' + rows + "</div>";
    }

    function viewMyPacks() {
      const packs = state.events.filter(function(e) { return e.kind === "pack_open"; });
      if (!packs.length) return "<p>Inga packs √∂ppnade √§nnu.</p>";
      const rows = packs.map(function(e) {
        return (
          '<div class="card">' +
            "<h3>üé¥ " + e.label + "</h3>" +
            "<p>Series: " + e.series + "</p>" +
            "<p>Rarity: " + e.rarity + "</p>" +
            "<p>Score: " + e.score + "</p>" +
          "</div>"
        );
      }).join("");
      return '<div class="card-grid">' + rows + "</div>";
    }

    function viewCreatorForge() {
      return (
        '<div class="card-grid">' +
          '<div class="card">' +
            "<h3>üõ† Forge New Pack Series</h3>" +
            "<p>G√• fr√•n bild ‚Üí rarity ‚Üí foil ‚Üí deploy.</p>" +
            '<button class="btn" data-action="start-forge">Start Forge Flow</button>' +
          "</div>" +
          '<div class="card">' +
            "<h3>üìö Manage Existing Series</h3>" +
            "<p>Visa och konfigurera redan deployade serier (kopplas till Factory-l√§gen senare).</p>" +
            '<button class="btn">Open Series Panel</button>' +
          "</div>" +
        "</div>"
      );
    }

    function viewPullLab() {
      return (
        '<div class="card-grid">' +
          '<div class="card">' +
            "<h3>üî• Fragment Gamble</h3>" +
            "<p>Burn 10x Fragments ‚Üí chans p√• Shard/Core.</p>" +
            '<button class="btn" data-action="fragment-burn">Simulate Burn</button>' +
          "</div>" +
          '<div class="card">' +
            "<h3>‚ö° Shard Gamble</h3>" +
            "<p>Burn 3x Shards ‚Üí chans p√• Artifact/Relic.</p>" +
            '<button class="btn" data-action="shard-burn">Simulate Burn</button>' +
          "</div>" +
          '<div class="card">' +
            "<h3>ü™ô Zora Packs</h3>" +
            "<p>K√∂p ZoraPack ‚Üí rarity multipliers p√• Zora value.</p>" +
            '<button class="btn" data-action="zora-pack">Open Zora Pack</button>' +
          "</div>" +
        "</div>"
      );
    }

    function viewPackMaps() {
      return (
        '<div class="packmap-wrap">' +
          '<canvas id="packmap-canvas" class="packmap-canvas"></canvas>' +
        "</div>"
      );
    }

    function drawPackMap() {
      const canvas = document.getElementById("packmap-canvas");
      if (!canvas || !canvas.getContext) return;
      const ctx = canvas.getContext("2d");
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (let i = 0; i < 60; i++) {
        const x = Math.random() * canvas.width;
        const y = Math.random() * canvas.height;
        const r = Math.random() * 4 + 2;
        const rarityColors = ["#4b5563", "#60a5fa", "#a855f7", "#facc15", "#f97316"];
        ctx.fillStyle = rarityColors[Math.floor(Math.random() * rarityColors.length)];
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function viewWarpVerified() {
      const verified = state.events.filter(function(e) { return e.tags.indexOf("mythic_hit") !== -1; });
      if (!verified.length) return "<p>Inga Warp Verified mythic hits √§nnu.</p>";
      const rows = verified.map(function(e) {
        return (
          '<div class="card">' +
            "<h3>üîí " + e.label + "</h3>" +
            "<p>Owner: " + e.owner + "</p>" +
            "<p>Score: " + e.score + "</p>" +
          "</div>"
        );
      }).join("");
      return '<div class="card-grid">' + rows + "</div>";
    }

    function viewBubbles() {
      return (
        '<div class="card-grid">' +
          '<div class="card">' +
            "<h3>üìà Trending Tags</h3>" +
            "<p>#GenesisPacks ¬∑ #ZoraPack ¬∑ #RelicHit</p>" +
          "</div>" +
          '<div class="card">' +
            "<h3>üì° Social Cast</h3>" +
            "<p>Posta ett mock-cast till Farcaster (framtida Neynar-integration).</p>" +
            '<button class="btn" id="cast-btn">Post Mock Cast</button>' +
          "</div>" +
        "</div>"
      );
    }

    function viewStatsEngine() {
      const s = state.stats;
      if (!s) return "<p>Stats loading...</p>";
      return (
        '<div class="metric-grid">' +
          '<div class="metric">' +
            '<div class="value">' + s.totalPacks + "</div>" +
            '<div class="label">Packs Opened</div>' +
          "</div>" +
          '<div class="metric">' +
            '<div class="value">' + s.cores + "</div>" +
            '<div class="label">Core Hits</div>' +
          "</div>" +
          '<div class="metric">' +
            '<div class="value">' + s.artifacts + "</div>" +
            '<div class="label">Artifacts</div>' +
          "</div>" +
          '<div class="metric">' +
            '<div class="value">' + s.relics + "</div>" +
            '<div class="label">Relics</div>' +
          "</div>" +
          '<div class="metric">' +
            '<div class="value">' + s.holderCount + "</div>" +
            '<div class="label">Unique Holders</div>' +
          "</div>" +
          '<div class="metric">' +
            '<div class="value">' + s.luckIndex + "</div>" +
            '<div class="label">Luck Index</div>' +
          "</div>" +
        "</div>"
      );
    }

    function viewDeployCenter() {
      return (
        '<div class="card-grid">' +
          '<div class="card">' +
            "<h3>üèó Deploy Guard + Factory</h3>" +
            "<p>ReserveGuard + PackFactory p√• Base (via Hardhat senare).</p>" +
            '<button class="btn" data-action="deploy-skeleton">Deploy Base Skeleton</button>' +
          "</div>" +
          '<div class="card">' +
            "<h3>üöÄ Deploy TokenPackSeries</h3>" +
            "<p>Starta en ny serie med din rarity-tabell.</p>" +
            '<button class="btn" data-action="deploy-series">Launch Series</button>' +
          "</div>" +
          '<div class="card">' +
            "<h3>‚úÖ Creator Registry</h3>" +
            "<p>Framtida modul f√∂r Warp Verified kreat√∂rer.</p>" +
            '<button class="btn" data-action="open-registry">Open Registry</button>' +
          "</div>" +
        "</div>"
      );
    }

    function viewProfile() {
      const p = state.profile;
      const walletText = state.wallet || "0x‚Ä¶.not-connected";

      const tasksHtml = state.daily.tasks.map(function(t) {
        return (
          '<li class="task-item ' + (t.done ? "done" : "") + '">' +
            '<div class="task-label">' +
              "<span>" + t.label + "</span>" +
              '<span class="task-xp">+' + t.xp + " XP</span>" +
            "</div>" +
            '<button class="btn btn-small" data-task-id="' + t.id + '">' +
              (t.done ? "Done" : "Complete") +
            "</button>" +
          "</li>"
        );
      }).join("");

      const tasksDone = state.daily.tasks.filter(function(t) { return t.done; }).length;

      return (
        '<div class="profile-header">' +
          "<div><strong>Spawn Profile</strong></div>" +
          '<div class="profile-wallet">' + walletText + "</div>" +
          '<div class="badge-row">' +
            '<span class="badge">üî• Streak: ' + p.streakDays + " days</span>" +
            '<span class="badge">‚≠ê XP: ' + p.xp + "</span>" +
            '<span class="badge">üèÖ Level ' + p.level + "</span>" +
            '<span class="badge">üéØ Best hit: ' + p.bestHit + "</span>" +
          "</div>" +
        "</div>" +

        '<div class="metric-grid">' +
          '<div class="metric">' +
            "<div class=\"value\">+25</div>" +
            '<div class="label">Daily XP Ready</div>' +
          "</div>" +
          '<div class="metric">' +
            '<div class="value">' + tasksDone + "/" + state.daily.tasks.length + "</div>" +
            '<div class="label">Tasks Done</div>' +
          "</div>" +
          '<div class="metric">' +
            "<div class=\"value\">3</div>" +
            '<div class="label">Quest Tier</div>' +
          "</div>" +
        "</div>" +

        '<div class="card" style="margin-top:0.6rem;">' +
          "<h3>üìã Daily Tasks</h3>" +
          '<ul class="task-list">' +
            tasksHtml +
          "</ul>" +
        "</div>" +

        '<div class="card" style="margin-top:0.6rem;">' +
          "<h3>üì§ Share Latest Pull</h3>" +
          "<p>Skicka din senaste Core/Relic-pull som cast (mock) till mesh-social lagret.</p>" +
          '<button class="btn" id="share-latest">Share latest pull</button>' +
        "</div>"
      );
    }

    function viewSettings() {
      return (
        '<div class="card-grid">' +
          '<div class="card">' +
            "<h3>üé® Theme</h3>" +
            "<p>Dark mode aktiverad. (Light disabled.)</p>" +
            '<button class="btn">Toggle Theme (mock)</button>' +
          "</div>" +
          '<div class="card">' +
            "<h3>üåê Network</h3>" +
            "<p>Aktiv kedja: " + NETWORK_INFO.name + "</p>" +
          "</div>" +
        "</div>"
      );
    }

    // --------------------------------------
    // GLOBAL CLICK HANDLER
    // --------------------------------------
    document.addEventListener("click", async function(e) {
      const target = e.target;

      // Cast-knapp i Bubbles
      if (target && target.id === "cast-btn") {
        await postCastMock(
          "Just pulled a Core via SpawnEngine Mesh!",
          "https://spawn-engine.vercel.app"
        );
        alert("Mock-cast skickad (kolla console).");
      }

      // Share pull i Trading
      if (target && target.dataset && target.dataset.shareId) {
        const id = target.dataset.shareId;
        const ev = state.events.find(function(ev) { return ev.id === id; });
        if (ev) {
          await postCastMock(
            "SpawnEngine pull: " + ev.label + " (" + ev.rarity + ")",
            "https://spawn-engine.vercel.app"
          );
          alert("Shared pull (mock).");
          // markera social-task som klar om inte redan
          const t = state.daily.tasks.find(function(t) { return t.id === "cast-social"; });
          if (t && !t.done) {
            t.done = true;
            state.profile.xp += t.xp;
            if (state.currentTab === "profile") switchView("profile");
          }
        }
      }

      // Daily task complete i Profile
      if (target && target.dataset && target.dataset.taskId) {
        const id = target.dataset.taskId;
        const task = state.daily.tasks.find(function(t) { return t.id === id; });
        if (task && !task.done) {
          task.done = true;
          state.profile.xp += task.xp;
          if (state.profile.xp >= 1500) state.profile.level = 5;
          if (state.currentTab === "profile") {
            switchView("profile");
          }
        }
      }

      // Share latest pull fr√•n Profile
      if (target && target.id === "share-latest") {
        const latestPack = state.events.find(function(e) { return e.kind === "pack_open"; });
        if (latestPack) {
          await postCastMock(
            "SpawnEngine pull: " + latestPack.label + " (" + latestPack.rarity + ")",
            "https://spawn-engine.vercel.app"
          );
          alert("Latest pull shared (mock).");
          const t = state.daily.tasks.find(function(t) { return t.id === "cast-social"; });
          if (t && !t.done) {
            t.done = true;
            state.profile.xp += t.xp;
            if (state.currentTab === "profile") switchView("profile");
          }
        } else {
          alert("Ingen pack_open hittades i mesh √§nnu.");
        }
      }

      // PullLab actions
      if (target && target.dataset && target.dataset.action) {
        const action = target.dataset.action;

        if (action === "fragment-burn") {
          addMeshEvent({
            kind: "burn",
            label: "Burn 10 Fragments (Lab)",
            short: "10xF",
            series: "Genesis",
            rarity: Math.random() < 0.3 ? "Core" : "Shard",
            owner: state.wallet || "0xlab...user",
            tags: ["burn", "lab"],
            score: 200
          });
          alert("Simulated fragment burn (mock).");
          const t = state.daily.tasks.find(function(t) { return t.id === "do-trade"; });
          if (t && !t.done) {
            t.done = true;
            state.profile.xp += t.xp;
            if (state.currentTab === "profile") switchView("profile");
          }
        }

        if (action === "shard-burn") {
          addMeshEvent({
            kind: "burn",
            label: "Burn 3 Shards (Lab)",
            short: "3xS",
            series: "Genesis",
            rarity: Math.random() < 0.5 ? "Artifact" : "Core",
            owner: state.wallet || "0xlab...user",
            tags: ["burn", "lab"],
            score: 800
          });
          alert("Simulated shard burn (mock).");
          const t = state.daily.tasks.find(function(t) { return t.id === "do-trade"; });
          if (t && !t.done) {
            t.done = true;
            state.profile.xp += t.xp;
            if (state.currentTab === "profile") switchView("profile");
          }
        }

        if (action === "zora-pack") {
          const rarity = randomRarityForZoraPack();
          addMeshEvent({
            kind: "pack_open",
            label: "ZoraPack Pull (" + rarity + ")",
            short: "ZP-" + rarity.toUpperCase().slice(0, 3),
            series: "ZoraPacks",
            rarity: rarity,
            owner: state.wallet || "0xzora...user",
            tags: ["zora", "pull"],
            score: rarity === "Relic" ? 10000 : rarity === "Artifact" ? 4000 : 500
          });
          alert("Opened ZoraPack (mock).");
          const t = state.daily.tasks.find(function(t) { return t.id === "open-pack"; });
          if (t && !t.done) {
            t.done = true;
            state.profile.xp += t.xp;
            if (state.currentTab === "profile") switchView("profile");
          }
        }

        if (action === "deploy-skeleton") {
          alert("H√§r kommer Hardhat/Foundry-deploy kopplas in (mock).");
        }

        if (action === "deploy-series") {
          alert("H√§r kommer TokenPackSeries deploy kopplas in (mock).");
        }

        if (action === "open-registry") {
          alert("CreatorRegistry-vy kopplas hit senare (mock).");
        }

        if (action === "start-forge") {
          alert("Creator Forge-flow (upload ‚Üí rarity ‚Üí foil ‚Üí deploy) kopplas in h√§r (mock).");
        }
      }
    });

    init();
  </script>
</body>
</html>